AWSTemplateFormatVersion: "2010-09-09"
Transform:
  - AWS::Serverless-2016-10-31

Description: >
  Root template for Cloud Resume Project. Orchestrates backend and website stacks.

Parameters:
  DomainName:
    Type: String
    Description: "Domain name for the website (e.g. example.com)"
  HostedZoneId:
    Type: String
    Description: "Route53 HostedZone ID for DomainName"
  CertificateArn:
    Type: String
    Description: "ACM certificate ARN in us-east-1 for CloudFront"

Resources:
  BackendStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: backend.yaml
      Parameters:
        DomainName: !Ref DomainName

  WebsiteBucketStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: website-bucket.yaml
      Parameters:
        DomainName: !Ref DomainName

  WebsiteCloudFrontStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: website-cloudfront.yaml
      Parameters:
        DomainName: !Ref DomainName
        HostedZoneId: !Ref HostedZoneId
        CertificateArn: !Ref CertificateArn
        BucketName: !GetAtt WebsiteBucketStack.Outputs.BucketName
        BucketRegionalDomainName: !GetAtt WebsiteBucketStack.Outputs.BucketRegionalDomainName
        OaiCanonicalUserId: !GetAtt WebsiteBucketStack.Outputs.OaiCanonicalUserId

Outputs:
  DynamoDBTableName:
    Description: "DynamoDB table name from backend"
    Value: !GetAtt BackendStack.Outputs.DynamoDBTableName

  LambdaFunctionName:
    Description: "Lambda function name from backend"
    Value: !GetAtt BackendStack.Outputs.LambdaFunctionName

  WebsiteURL:
    Description: "CloudFront distribution domain from website cloudfront stack"
    Value: !GetAtt WebsiteCloudFrontStack.Outputs.DistributionDomainName

  WebsiteBucketName:
    Description: "S3 Bucket name from website bucket stack"
    Value: !GetAtt WebsiteBucketStack.Outputs.BucketName
